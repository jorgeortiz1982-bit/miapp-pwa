import{c as b,d,f as g,g as u}from"./chunk-NPNKERU2.js";import{e as s}from"./chunk-JHI3MBHO.js";function w(h,e,t){return s(this,null,function*(){let i;return Promise.race([h,new Promise((a,r)=>{i=setTimeout(()=>r(t),e)})]).finally(()=>clearTimeout(i))})}var f=class extends b{constructor(){super(...arguments),this.deviceMap=new Map,this.discoveredDevices=new Map,this.scan=null,this.DEFAULT_CONNECTION_TIMEOUT=1e4,this.onAdvertisementReceivedCallback=this.onAdvertisementReceived.bind(this),this.onDisconnectedCallback=this.onDisconnected.bind(this),this.onCharacteristicValueChangedCallback=this.onCharacteristicValueChanged.bind(this)}initialize(){return s(this,null,function*(){if(typeof navigator>"u"||!navigator.bluetooth)throw this.unavailable("Web Bluetooth API not available in this browser.");if(!(yield navigator.bluetooth.getAvailability()))throw this.unavailable("No Bluetooth radio available.")})}isEnabled(){return s(this,null,function*(){return{value:!0}})}requestEnable(){return s(this,null,function*(){throw this.unavailable("requestEnable is not available on web.")})}enable(){return s(this,null,function*(){throw this.unavailable("enable is not available on web.")})}disable(){return s(this,null,function*(){throw this.unavailable("disable is not available on web.")})}startEnabledNotifications(){return s(this,null,function*(){})}stopEnabledNotifications(){return s(this,null,function*(){})}isLocationEnabled(){return s(this,null,function*(){throw this.unavailable("isLocationEnabled is not available on web.")})}openLocationSettings(){return s(this,null,function*(){throw this.unavailable("openLocationSettings is not available on web.")})}openBluetoothSettings(){return s(this,null,function*(){throw this.unavailable("openBluetoothSettings is not available on web.")})}openAppSettings(){return s(this,null,function*(){throw this.unavailable("openAppSettings is not available on web.")})}setDisplayStrings(){return s(this,null,function*(){})}requestDevice(e){return s(this,null,function*(){let t=this.getFilters(e),i=yield navigator.bluetooth.requestDevice({filters:t.length?t:void 0,optionalServices:e?.optionalServices,acceptAllDevices:t.length===0});return this.deviceMap.set(i.id,i),this.getBleDevice(i)})}requestLEScan(e){return s(this,null,function*(){this.requestBleDeviceOptions=e;let t=this.getFilters(e);yield this.stopLEScan(),this.discoveredDevices=new Map,navigator.bluetooth.removeEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),navigator.bluetooth.addEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),this.scan=yield navigator.bluetooth.requestLEScan({filters:t.length?t:void 0,acceptAllAdvertisements:t.length===0,keepRepeatedDevices:e?.allowDuplicates})})}onAdvertisementReceived(e){var t,i,a;let r=e.device.id;this.deviceMap.set(r,e.device);let n=!this.discoveredDevices.has(r);if(!(!((t=this.requestBleDeviceOptions)===null||t===void 0)&&t.serviceData&&!this.matchesServiceDataFilter(e))&&(n||!((i=this.requestBleDeviceOptions)===null||i===void 0)&&i.allowDuplicates)){this.discoveredDevices.set(r,!0);let o=this.getBleDevice(e.device),l={device:o,localName:o.name,rssi:e.rssi,txPower:e.txPower,manufacturerData:u(e.manufacturerData),serviceData:u(e.serviceData),uuids:(a=e.uuids)===null||a===void 0?void 0:a.map(g)};this.notifyListeners("onScanResult",l)}}stopLEScan(){return s(this,null,function*(){var e;!((e=this.scan)===null||e===void 0)&&e.active&&this.scan.stop(),this.scan=null})}getDevices(e){return s(this,null,function*(){return{devices:(yield navigator.bluetooth.getDevices()).filter(a=>e.deviceIds.includes(a.id)).map(a=>(this.deviceMap.set(a.id,a),this.getBleDevice(a)))}})}getConnectedDevices(e){return s(this,null,function*(){return{devices:(yield navigator.bluetooth.getDevices()).filter(a=>{var r;return(r=a.gatt)===null||r===void 0?void 0:r.connected}).map(a=>(this.deviceMap.set(a.id,a),this.getBleDevice(a)))}})}getBondedDevices(){return s(this,null,function*(){return{}})}connect(e){return s(this,null,function*(){var t,i;let a=this.getDeviceFromMap(e.deviceId);a.removeEventListener("gattserverdisconnected",this.onDisconnectedCallback),a.addEventListener("gattserverdisconnected",this.onDisconnectedCallback);let r=Symbol();if(a.gatt===void 0)throw new Error("No gatt server available.");try{let n=(t=e.timeout)!==null&&t!==void 0?t:this.DEFAULT_CONNECTION_TIMEOUT;yield w(a.gatt.connect(),n,r)}catch(n){throw yield(i=a.gatt)===null||i===void 0?void 0:i.disconnect(),n===r?new Error("Connection timeout"):n}})}onDisconnected(e){let i=`disconnected|${e.target.id}`;this.notifyListeners(i,null)}createBond(e){return s(this,null,function*(){throw this.unavailable("createBond is not available on web.")})}isBonded(e){return s(this,null,function*(){throw this.unavailable("isBonded is not available on web.")})}disconnect(e){return s(this,null,function*(){var t;(t=this.getDeviceFromMap(e.deviceId).gatt)===null||t===void 0||t.disconnect()})}getServices(e){return s(this,null,function*(){var t,i;let a=(i=yield(t=this.getDeviceFromMap(e.deviceId).gatt)===null||t===void 0?void 0:t.getPrimaryServices())!==null&&i!==void 0?i:[],r=[];for(let n of a){let o=yield n.getCharacteristics(),l=[];for(let c of o)l.push({uuid:c.uuid,properties:this.getProperties(c),descriptors:yield this.getDescriptors(c)});r.push({uuid:n.uuid,characteristics:l})}return{services:r}})}getDescriptors(e){return s(this,null,function*(){try{return(yield e.getDescriptors()).map(i=>({uuid:i.uuid}))}catch{return[]}})}getProperties(e){return{broadcast:e.properties.broadcast,read:e.properties.read,writeWithoutResponse:e.properties.writeWithoutResponse,write:e.properties.write,notify:e.properties.notify,indicate:e.properties.indicate,authenticatedSignedWrites:e.properties.authenticatedSignedWrites,reliableWrite:e.properties.reliableWrite,writableAuxiliaries:e.properties.writableAuxiliaries}}getCharacteristic(e){return s(this,null,function*(){var t;let i=yield(t=this.getDeviceFromMap(e.deviceId).gatt)===null||t===void 0?void 0:t.getPrimaryService(e?.service);return i?.getCharacteristic(e?.characteristic)})}getDescriptor(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e);return t?.getDescriptor(e?.descriptor)})}discoverServices(e){return s(this,null,function*(){throw this.unavailable("discoverServices is not available on web.")})}getMtu(e){return s(this,null,function*(){throw this.unavailable("getMtu is not available on web.")})}requestConnectionPriority(e){return s(this,null,function*(){throw this.unavailable("requestConnectionPriority is not available on web.")})}readRssi(e){return s(this,null,function*(){throw this.unavailable("readRssi is not available on web.")})}read(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e);return{value:yield t?.readValue()}})}write(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e),i;typeof e.value=="string"?i=d(e.value):i=e.value,yield t?.writeValueWithResponse(i)})}writeWithoutResponse(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e),i;typeof e.value=="string"?i=d(e.value):i=e.value,yield t?.writeValueWithoutResponse(i)})}readDescriptor(e){return s(this,null,function*(){let t=yield this.getDescriptor(e);return{value:yield t?.readValue()}})}writeDescriptor(e){return s(this,null,function*(){let t=yield this.getDescriptor(e),i;typeof e.value=="string"?i=d(e.value):i=e.value,yield t?.writeValue(i)})}startNotifications(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e);t?.removeEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),t?.addEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),yield t?.startNotifications()})}onCharacteristicValueChanged(e){var t,i;let a=e.target,r=`notification|${(t=a.service)===null||t===void 0?void 0:t.device.id}|${(i=a.service)===null||i===void 0?void 0:i.uuid}|${a.uuid}`;this.notifyListeners(r,{value:a.value})}stopNotifications(e){return s(this,null,function*(){let t=yield this.getCharacteristic(e);yield t?.stopNotifications()})}getFilters(e){var t,i;let a=[];for(let r of(t=e?.services)!==null&&t!==void 0?t:[])a.push({services:[r],name:e?.name,namePrefix:e?.namePrefix});(e?.name||e?.namePrefix)&&a.length===0&&a.push({name:e.name,namePrefix:e.namePrefix});for(let r of(i=e?.manufacturerData)!==null&&i!==void 0?i:[])a.push({manufacturerData:[r]});return a}matchesServiceDataFilter(e){var t;let i=(t=this.requestBleDeviceOptions)===null||t===void 0?void 0:t.serviceData;if(!i||i.length===0)return!0;if(!e.serviceData)return!1;for(let a of i){let r=e.serviceData.get(a.serviceUuid);if(!r)continue;if(!a.dataPrefix)return!0;let n=new Uint8Array(r.buffer),o=a.dataPrefix;if(!(n.length<o.byteLength))if(a.mask){let l=a.mask,c=!0;for(let v=0;v<o.byteLength;v++)if((n[v]&l.getUint8(v))!==(o.getUint8(v)&l.getUint8(v))){c=!1;break}if(c)return!0}else{let l=!0;for(let c=0;c<o.byteLength;c++)if(n[c]!==o.getUint8(c)){l=!1;break}if(l)return!0}}return!1}getDeviceFromMap(e){let t=this.deviceMap.get(e);if(t===void 0)throw new Error('Device not found. Call "requestDevice", "requestLEScan" or "getDevices" first.');return t}getBleDevice(e){var t;return{deviceId:e.id,name:(t=e.name)!==null&&t!==void 0?t:void 0}}};export{f as BluetoothLeWeb};
